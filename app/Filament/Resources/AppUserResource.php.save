<?php

namespace App\Filament\Resources;

use App\Filament\Resources\AppUserResource\Pages;
use App\Filament\Resources\AppUserResource\RelationManagers;
use App\Filament\Resources\AppUserResource\RelationManagers\ViewsRelationManager;
use App\Filament\Resources\AppUserResource\RelationManagers\SubscriptionsRelationManager;
use App\Models\app_user as AppUser;
use Filament\Forms;
use Filament\Resources\Form;
use Filament\Resources\Resource;
use Filament\Resources\Table;
use Filament\Tables;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\SoftDeletingScope;

class AppUserResource extends Resource
{
    protected static ?string $model = AppUser::class;

    protected static ?string $navigationIcon = 'heroicon-o-users';

    protected static ?string $navigationGroup = 'User Management';

    protected static ?int $sort = 1;

    public static function form(Form $form): Form
    {
        return $form
            ->schema([
                 Forms\Components\Card::make()
                    ->schema([
                        Forms\Components\TextInput::make('name')
                            ->label("Full name")
                            ->required(),
                        Forms\Components\TextInput::make('phone')
                            ->required(),
                        Forms\Components\Select::make('user_type')
                            ->options([
                                'student' => 'Student',
                                'school' => 'School',
                            ])
                            ->searchable( )
                            ->required(), 
                             
                         Forms\Components\Select::make('region')
                        ->options(function () {
                            $regions = self::getTanzaniaRegions();
                            $regionNames = array_keys($regions);
                            return array_combine($regionNames, $regionNames);
                        })
                        ->searchable()
                        ->reactive() // This is crucial!
                        ->required(),

                       Forms\Components\Select::make('district')
                        ->options(function (callable $get) {
                            $selectedRegion = $get('region');

                            if (!$selectedRegion) {
                                return [];
                            }
                            
                            $regions = self::getTanzaniaRegions();
                            $districts = $regions[$selectedRegion];
                            return array_combine($districts, $districts);
                        })
                        ->searchable()
                        ->required(),

                        Forms\Components\Select::make('status')
                            ->options([
                                'active' => 'Active',
                                'inactive' => 'Inactive',
                            ])
                            ->default('active')
                            ->searchable( )
                            ->required(),        
                        

                    ])

            ]);
    }

    public static function table(Table $table): Table
    {
        return $table
            ->columns([
                Tables\Columns\TextColumn::make('name')->searchable(),
                Tables\Columns\TextColumn::make('phone')->searchable()->sortable()->default(0)->size('sm'),
                Tables\Columns\TextColumn::make('sex')->searchable()->sortable()->default(0)->size('sm'),
                Tables\Columns\TextColumn::make('region')->sortable()->default(0)->size('sm'),
                Tables\Columns\TextColumn::make('district')->searchable()->sortable()->default(0)->size('sm'),
                Tables\Columns\TextColumn::make('status')->searchable()->sortable()->default(0)->size('sm'),
                Tables\Columns\TextColumn::make('created_at')->searchable()->sortable()->default(0)->size('sm'),
            ])
             ->defaultSort('id', 'desc')
            ->filters([
                //
            ])
            ->actions([
                Tables\Actions\EditAction::make(),
            ])
            ->bulkActions([
                Tables\Actions\DeleteBulkAction::make(),
            ]);
    }

    public static function getTanzaniaRegions(): array
    {
        return [
            "Arusha" => ["Arusha City", "Arusha Rural", "Karatu", "Longido", "Meru", "Monduli", "Ngorongoro"],
            "Dar es salaam" => ["Ilala", "Kinondoni", "Temeke", "Kigamboni", "Ubungo"],
            "Dodoma" => ["Bahi", "Chamwino", "Chemba", "Dodoma City", "Kondoa", "Kongwa", "Mpwapwa"],
            "Geita" => ["Bukombe", "Chato", "Geita Town", "Mbogwe", "Nyang'hwale"],
            "Iringa" => ["Iringa Rural", "Iringa Urban", "Kilolo", "Mufindi"],
            "Kagera" => ["Biharamulo", "Bukoba Rural", "Bukoba Urban", "Karagwe", "Kyerwa", "Missenyi", "Muleba", "Ngara"],
            "Katavi" => ["Mlele", "Mpanda Rural", "Mpanda Urban"],
            "Kigoma" => ["Buhigwe", "Kakonko", "Kasulu Rural", "Kasulu Urban", "Kibondo", "Kigoma Rural", "Kigoma Urban", "Uvinza"],
            "Kilimanjaro" => ["Hai", "Moshi Rural", "Moshi Urban", "Mwanga", "Rombo", "Same", "Siha"],
            "Lindi" => ["Kilwa", "Lindi Rural", "Lindi Urban", "Liwale", "Nachingwea", "Ruangwa"],
            "Manyara" => ["Babati Rural", "Babati Urban", "Hanang", "Kiteto", "Mbulu", "Simanjiro"],
            "Mara" => ["Bunda", "Butiama", "Musoma Rural", "Musoma Urban", "Rorya", "Serengeti", "Tarime"],
            "Mbeya" => ["Busokelo", "Chunya", "Kyela", "Mbarali", "Mbeya City", "Mbeya Rural", "Rungwe"],
            "Morogoro" => ["Gairo", "Kilombero", "Kilosa", "Morogoro Rural", "Morogoro Urban", "Mvomero", "Ulanga"],
            "Mtwara" => ["Masasi", "Mtwara Rural", "Mtwara Urban", "Nanyumbu", "Newala", "Tandahimba"],
            "Mwanza" => ["Ilemela", "Kwimba", "Magu", "Misungwi", "Nyamagana", "Sengerema", "Ukerewe"],
            "Njombe" => ["Ludewa", "Makambako Town", "Makete", "Njombe Rural", "Njombe Urban", "Wanging'ombe"],
            "Pwani" => ["Bagamoyo", "Kibaha Rural", "Kibaha Urban", "Kisarawe", "Mafia", "Mkuranga", "Rufiji"],
            "Rukwa" => ["Kalambo", "Nkasi", "Sumbawanga Rural", "Sumbawanga Urban"],
            "Ruvuma" => ["Mbinga", "Namtumbo", "Nyasa", "Songea Rural", "Songea Urban", "Tunduru"],
            "Shinyanga" => ["Kahama Rural", "Kahama Urban", "Kishapu", "Shinyanga Rural", "Shinyanga Urban"],
            "Simiyu" => ["Bariadi", "Busega", "Itilima", "Maswa", "Meatu"],
            "Singida" => ["Ikungi", "Iramba", "Manyoni", "Mkalama", "Singida Rural", "Singida Urban"],
            "Songwe" => ["Ileje", "Mbozi", "Momba", "Songwe"],
            "Tabora" => ["Igunga", "Kaliua", "Nzega", "Sikonge", "Tabora Urban", "Urambo", "Uyui"],
            "Tanga" => ["Bumbuli", "Handeni Rural", "Handeni Urban", "Kilindi", "Korogwe", "Lushoto", "Mkinga", "Muheza", "Pangani", "Tanga City"],
        ];
    }
    public static function getRelations(): array
    {
        return [
            ViewsRelationManager::class,
            SubscriptionsRelationManager::class,
        ];
    }

    protected function getTableQuery(): Builder
    {
        return parent::getTableQuery()->with('user_region');
    }

    public static function getPages(): array
    {
        return [
            'index' => Pages\ListAppUsers::route('/'),
            'create' => Pages\CreateAppUser::route('/create'),
            'edit' => Pages\EditAppUser::route('/{record}/edit'),
        ];
    }
}
